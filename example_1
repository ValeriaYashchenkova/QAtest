pipeline {
    agent {
        kubernetes {
            inheritFrom 'python'
            defaultContainer 'python-builder'
        }
    }

    // Запускаем только при изменениях в master
    triggers {
        pollSCM('') // пустая строка = следить за изменениями в репозитории
        // или можно явно: cron('H/15 * * * *') если нужен периодический запуск
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '20'))
        timeout(time: 60, unit: 'MINUTES')
    }

    environment {
        PATH = "/var/lib/jenkins/.local/bin:$PATH"
        ALLURE_RESULTS = "allure-results"
        TESTOPS_ENDPOINT    = 'https://testops.moscow.alfaintra.net'
        TESTOPS_PROJECT_ID  = '643'
        TESTOPS_SERVER_ID   = 'testOps'
    }

    stages {
        stage('Checkout SCM') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: 'master']],
                    userRemoteConfigs: [[
                        url: 'https://git.moscow.alfaintra.net/scm/bialm_ft/bialm_ft_auto.git',
                        credentialsId: 'login_password_for_repo_bitbucket'
                    ]]
                ])
            }
        }

        stage('Prepare environment') {
            steps {
                sh '''
                    python3.7 -m venv venv
                    . venv/bin/activate
                    
                    pip3.7 install --upgrade pip
                    pip3.7 install -r requirements.txt -i https://binary.alfabank.ru/artifactory/api/pypi/pipy-virtual/simple
                    
                    # Убедимся, что allure-pytest установлен (на всякий случай)
                    pip3.7 install allure-pytest --upgrade
                '''
            }
        }

        stage('Run tests → Allure results') {
            steps {
                sh '''
                    . venv/bin/activate
                    
                    # Гарантированно чистая папка перед запуском
                    rm -rf ${ALLURE_RESULTS}
                    mkdir -p ${ALLURE_RESULTS}
                    
                    pytest tests --alluredir=${ALLURE_RESULTS} -v
                '''
            }
        }
    }

    post {
        always {
            // 1. Публикуем отчёт локально в Jenkins (через официальный Allure плагин)
            allure([
                includeProperties: false,
                reportBuildPolicy: 'ALWAYS',
                results: [[path: "${ALLURE_RESULTS}"]]
            ])

            // 2. Отправляем результаты в Allure TestOps
            script {
                try {
                    echo "Uploading results to Allure TestOps..."
                    allureTestOpsUpload(
                        allureResultsPath: "${ALLURE_RESULTS}",
                        endpoint:          "${TESTOPS_ENDPOINT}",
                        projectId:         "${TESTOPS_PROJECT_ID}",
                        serverId:          "${TESTOPS_SERVER_ID}",
                        launchName:        "Jenkins #${BUILD_NUMBER} | ${BRANCH_NAME}",
                        failFast:          false
                    )
                    echo "Successfully uploaded to Allure TestOps"
                } catch (Exception e) {
                    echo "Failed to upload to Allure TestOps: ${e}"
                    // Билд НЕ падает — это важно, если TestOps временно недоступен
                }
            }

            // 3. Архивация raw-результатов (на всякий случай)
            archiveArtifacts artifacts: "${ALLURE_RESULTS}/**", allowEmptyArchive: true
        }

        cleanup {
            // Полная очистка workspace после билда (освобождаем место на ноде)
            cleanWs()
        }
    }
}
